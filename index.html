<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>๐ ะะฒะพะฝะบะธ</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <h2>๐ ะกะฐะนั ะทะฒะพะฝะบะพะฒ</h2>

  <!-- ะะตะณะธัััะฐัะธั / ะัะพะด -->
  <input id="username" placeholder="ะะธะบ">
  <input id="password" type="password" placeholder="ะะฐัะพะปั">
  <button onclick="register()">ะะตะณะธัััะฐัะธั</button>
  <button onclick="login()">ะัะพะด</button>

  <!-- ะะพะธัะบ ะฟะพะปัะทะพะฒะฐัะตะปะตะน -->
  <input id="search" placeholder="ะะพะธัะบ ะฟะพ ะฝะธะบั">
  <button onclick="searchUser()">ะะฐะนัะธ</button>
  <ul id="results"></ul>

  <!-- ะะพะฝัะตะนะฝะตัั ะดะปั ะทะฒะพะฝะบะพะฒ -->
  <button id="callAudio">๐ ะัะดะธะพ-ะทะฒะพะฝะพะบ</button>
  <button id="callVideo">๐ฅ ะะธะดะตะพ-ะทะฒะพะฝะพะบ</button>
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>

<script>
const socket = io("http://localhost:5000");
const peer = new RTCPeerConnection();

async function register() {
  await fetch("/register", { method:"POST", headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username: username.value, password: password.value }) });
}

async function login() {
  await fetch("/login", { method:"POST", headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username: username.value, password: password.value }) });
}

async function searchUser() {
  const q = document.getElementById("search").value;
  const res = await fetch("/search?q=" + q);
  const list = await res.json();
  document.getElementById("results").innerHTML = list.map(u => `<li>${u}</li>`).join("");
}

function startCall(video=false) {
  navigator.mediaDevices.getUserMedia({ audio: true, video })
    .then(stream => {
      stream.getTracks().forEach(track => peer.addTrack(track, stream));
      if(video) document.getElementById("localVideo").srcObject = stream;
    });
}

document.getElementById("callAudio").onclick = () => {
  startCall(false);
  navigator.vibrate([300,200,300]);
  new Notification("๐ ะัะพะดััะธะน ะฐัะดะธะพ-ะทะฒะพะฝะพะบ", { body: "ะะฐะถะผะธัะต, ััะพะฑั ะฟัะธะฝััั" });
};

document.getElementById("callVideo").onclick = () => {
  startCall(true);
  navigator.vibrate([500,200,500]);
  new Notification("๐ฅ ะัะพะดััะธะน ะฒะธะดะตะพ-ะทะฒะพะฝะพะบ", { body: "ะะฐะถะผะธัะต, ััะพะฑั ะฟัะธะฝััั" });
};

peer.ontrack = event => {
  document.getElementById("remoteVideo").srcObject = event.streams[0];
};

peer.onicecandidate = e => {
  if(e.candidate) socket.emit("candidate", e.candidate);
};
socket.on("candidate", c => peer.addIceCandidate(new RTCIceCandidate(c)));
</script>
</body>
</html>
