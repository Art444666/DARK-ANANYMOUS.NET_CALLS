<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>üìû DARK Anonymous Calls</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #0d1117, #1a1f2b);
      color: #e6edf3;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      width: 100%;
      padding: 20px;
      text-align: center;
      background: linear-gradient(135deg, #111827, #1f2937);
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    header h1 {
      margin: 0;
      font-size: 28px;
      color: #58a6ff;
      text-shadow: 0 0 12px rgba(88,166,255,0.8);
    }
    .card {
      background: rgba(22,27,34,0.9);
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 20px;
      margin: 20px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.6);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 28px rgba(0,0,0,0.8);
    }
    input, button {
      margin: 8px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #30363d;
      background: #0d1117;
      color: #e6edf3;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    input:focus {
      border-color: #58a6ff;
      box-shadow: 0 0 8px rgba(88,166,255,0.6);
      outline: none;
    }
    button {
      cursor: pointer;
      background: linear-gradient(135deg, #238636, #2ea043);
      border: none;
      font-weight: bold;
      color: #fff;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 12px rgba(46,160,67,0.6);
    }
    video {
      width: 45%;
      margin: 10px;
      border-radius: 12px;
      border: 2px solid #30363d;
      background: #000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    ul { list-style: none; padding: 0; }
    li {
      padding: 8px;
      margin: 4px 0;
      background: linear-gradient(135deg, #21262d, #161b22);
      border-radius: 8px;
      transition: transform 0.2s ease;
      cursor: pointer;
    }
    li:hover { transform: translateX(5px); background: #2d333b; }
  </style>
</head>
<body>
  <header>
    <h1>üí¨ DARK Anonymous Calls</h1>
  </header>

  <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –í—Ö–æ–¥ -->
  <div class="card">
    <h3>üîë –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –í—Ö–æ–¥</h3>
    <input id="username" placeholder="–ù–∏–∫">
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button onclick="login()">–í—Ö–æ–¥</button>
  </div>

  <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
  <div class="card">
    <h3>üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
    <input id="search" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏–ª–∏ –±—É–∫–≤—ã">
    <button onclick="searchUser()">–ù–∞–π—Ç–∏</button>
    <ul id="results"></ul>
  </div>

  <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
  <div class="card">
    <h3>üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</h3>
    <input id="message" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <ul id="chat"></ul>
  </div>

  <!-- –ó–≤–æ–Ω–∫–∏ -->
  <div class="card">
    <h3>üìû –ó–≤–æ–Ω–∫–∏</h3>
    <button id="callAudio">üîä –ê—É–¥–∏–æ-–∑–≤–æ–Ω–æ–∫</button>
    <button id="callVideo">üé• –í–∏–¥–µ–æ-–∑–≤–æ–Ω–æ–∫</button>
    <button onclick="toggleCalls()">üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–≤–æ–Ω–∫–∏</button>
  </div>

  <!-- –í–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã -->
  <div class="card">
    <h3>üé• –í–∏–¥–µ–æ</h3>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

<script>
const socket = io("http://localhost:5000"); // –∑–∞–º–µ–Ω–∏—à—å –Ω–∞ Render URL
const peer = new RTCPeerConnection();
let currentTarget = null;

async function register() {
  await fetch("/register", { method:"POST", headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username: username.value, password: password.value }) });
}

async function login() {
  await fetch("/login", { method:"POST", headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username: username.value, password: password.value }) });
}

async function searchUser() {
  const q = document.getElementById("search").value;
  const res = await fetch("/search?q=" + q);
  const list = await res.json();
  document.getElementById("results").innerHTML = list.map(u =>
    `<li onclick="selectUser('${u}')">${u}</li>`).join("");
}

function selectUser(u) {
  currentTarget = u;
  alert("–í—ã –≤—ã–±—Ä–∞–ª–∏: " + u);
}

function sendMessage() {
  const msg = document.getElementById("message").value;
  if(currentTarget) {
    socket.emit("message", { to: currentTarget, text: msg });
    document.getElementById("chat").innerHTML += `<li>–í—ã: ${msg}</li>`;
  }
}

function startCall(video=false) {
  navigator.mediaDevices.getUserMedia({ audio: true, video })
    .then(stream => {
      stream.getTracks().forEach(track => peer.addTrack(track, stream));
      if(video) document.getElementById("localVideo").srcObject = stream;
      socket.emit("call", { from: "me", to: currentTarget });
    });
}

document.getElementById("callAudio").onclick = () => {
  startCall(false);
  navigator.vibrate([300,200,300]);
};

document.getElementById("callVideo").onclick = () => {
  startCall(true);
  navigator.vibrate([500,200,500]);
};

async function toggleCalls() {
  const res = await fetch("/toggle_calls", { method:"POST" });
  const data = await res.json();
  alert("–ü—Ä–∏—ë–º –∑–≤–æ–Ω–∫–æ–≤: " + data.allow_calls);
}

peer.ontrack = event => {
  document.getElementById("remoteVideo").srcObject = event.streams[0];
};

peer.onicecandidate = e => {
  if(e.candidate) socket.emit("candidate", e.candidate);
};
socket.on("candidate", c => peer.addIceCandidate(new RTCIceCandidate(c)));

socket.on("incoming_call", data => {
  new Notification("üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫", { body: "–û—Ç: " + data.from });
});
</script>
</body>
</html>
